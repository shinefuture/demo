# Kbuild架构

## GNU Make基础

### 1. make 概述
#### 1.1 编译规则是：
```
1. 如果这个工程没有编译过，那么我们的所有C文件都要编译并被链接。
2. 如果这个工程的某几个C文件被修改，那么我们只编译被修改的C文件，并链接目标程序。
3. 如果这个工程的头文件被改变了，那么我们需要编译引用了这几个头文件的C文件，并链接目标程序。
```

#### 1.2 make的执行过程如下：
```
1. 依次读取变量“MAKEFILES”定义的makefile文件列表
2. 读取工作目录下的makefile文件（根据命名的查找顺序“GNUmakefile”，“makefile”，“Makefile”，首先找到那个就读取那个），或者使用-f指定的makefile文件
3. 依次读取工作目录makefile文件中使用指示符“include”包含的文件
4. 查找重建所有已读取的makefile文件的规则（如果存在一个目标是当前读取的某一个makefile文件，则执行此规则重建此makefile文件，完成以后从第一步开始重新执行）
5. 初始化变量值并展开那些需要立即展开的变量和函数并根据预设条件确定执行分支
6. 根据“终极目标”以及其他目标的依赖关系建立依赖关系链表
7. 执行除“终极目标”以外的所有的目标的规则（规则中如果依赖文件中任一个文件的时间戳比目标文件新，则使用规则所定义的命令重建目标文件）
8. 执行“终极目标”所在的规则
```

#### 1.3 包含其他Makefile文件：
使用include来包含其它Makefile，如果指示符"include"指定的文件不是以绝对路径表示，而且当前目录下也不存在此文件；make将根据文件名试图在以下几个目录查找：
	- 首先，查找使用命令行选项“-I"或者“-include-dir”指定的目录，如果找到指定的文件，则使用此文件；
	- 否则，依次搜索以下几个目录（如果其存在）："/usr/gnu/include"、"/usr/local/include"和"/usr/include"
	- 若仍未找到，make将会提示一个文件未找到的告警提示，但是不会退出。而是继续处理Makefile的后续内容。当完成读取整个Makefile后，make将试图使用规则来创建通过指示符"include"指定的但未找到的文件，当不能创建它时，make将提示致命错误并退出。
通常，使用"-include"来代替"include"，来忽略由于文件不村子或者无法创建时的错误提示。
“-”即告诉make，忽略此操作的错误，make继续执行。

为了和其它的make程序进行兼容，也可以使用"sinclue"来代替"-include"（GNU所支持的方式）。

#### 1.4 环境变量
- MAKEFILES
	如果在当前环境定义了一个"MAKEFILES"环境变量，make执行时首先将此变量的值作为需要读入的Makefile文件，多个文件之间使用空格分开。
	与include的区别：
	- 环境变量指定的makefile文件中的“目标”不会被作为make执行的“终极目标”
	- 环境变量所定义的文件列表，在执行make时，如果不能找到其中某一个文件（不存在或无法创建），make不会提示错误，也不退出
	- make在执行时，首先读取的是环境变量"MAKEFILES"所指定的文件列表，之后才是工作目录下的makefile文件；而"include"所指定的文件是在make发现此关键字时暂停正在读取的文件而去读取"include"所指定的文件。

- MAKEFILE_LIST
	make程序在读取多个makefile文件时，包括由"MAKEFILES"指定、当前工作目录下默认以及使用"include"包含的，在对这些文件进行解析执行之前make读取的文件名将会被自动依次追加到变量"MAKEFILE_LIST"的定义域中。
	获取最后一个字的方式如下：
	name := $(word $(words $(MAKEFILE_LIST)), $(MAKEFILE_LIST))
- .VARIABLES
	此变量不能通过任何途径给它赋值，它被展开以后是此引用点之前、makefile文件中所定义的所有全局变量列表。
	包括：空变量（未赋值的变量）和make的内嵌变量，但不包括目标所指定的变量，目标指定变量值在特定目标的上下文有效。

### 2. Makefile的规则

#### 2.1 终极目标
它是makefile文件中第一个规则的目标。
如果makefile中第一个规则有多个目标的话，那么多个目标中的第一个将会被作为make的"终极目标"。
有两种情况除外，此两种情况不会被作为"终极目标"：
- 目标名以点号"."开始的并且其后不存在斜线"/"("./"被认为是当前目录；"../"被认为是上一级目录)
- 模式规则的目标



## Kbuild原理

Kbuild执行的几个步骤(大致)：

1) 根据内核配置生成文件 .config

2) 将内核的版本号存储在 include/linux/version.h

3) 生成指向 include/asm-$(ARCH) 的符号链接

4) 更新所有编译所需的文件： 附加的文件由 arch/$(ARCH)/Makefile 指定。

5) 递归向下访问所有在下列变量中列出的目录： init-* core* drivers-* net-* libs-*，并编译生成目标文件。这些变量的值可以在 arch/$(ARCH)/Makefile 中扩充。

6) 联接所有的目标文件，在源代码树顶层目录中生成 vmlinux。最先联接是在 head-y中列出的文件，该变量由 arch/$(ARCH)/Makefile 赋值。

7) 最后完成具体架构的特殊要求，并生成最终的启动镜像。

   -- 包含生成启动指令

   -- 准备 initrd 镜像或类似文件